/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var w=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var B=(h,t)=>{for(var e in t)w(h,e,{get:t[e],enumerable:!0})},H=(h,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of V(t))!R.call(h,s)&&s!==e&&w(h,s,{get:()=>t[s],enumerable:!(i=S(t,s))||i.enumerable});return h};var A=h=>H(w({},"__esModule",{value:!0}),h);var P={};B(P,{default:()=>I});module.exports=A(P);var M=require("obsidian");var N=require("obsidian");var u=class{constructor(t,e){this.app=t,this.file=e}getBacklinks(){let t=this.app.metadataCache.getBacklinksForFile(this.file);return t.data.delete(this.file.path),t}async getBacklinksHierarchy(){let t=[],e={result:t},i=this.getBacklinks();for(let[s,n]of i.data.entries()){let a=s.split("/"),r=this.app.vault.getFileByPath(s);if(r){let o=await this.app.vault.cachedRead(r),p=await this.getReferences(s,n);a.reduce((l,d,f,m)=>{if(!l[d]){l[d]={result:[]};let x=[],y={name:d,children:l[d].result,content:o,references:x};f==a.length-1&&(y.references=p),l.result.push(y)}return l[d]},e)}}return t}async getReferences(t,e){let i=[],s={path:t,content:[],properties:[]};return e.forEach(n=>{if(n.position){let l=[n.position.start.offset,n.position.end.offset];s.content.push(l)}else{let l=n.key.split("."),d=l[0],f=l.slice(1);var a=[];if(f){a=[];for(var r=0,c=f;r<c.length;r++){var o=c[r],p=Number(o);a.push(Number.isNaN(p)?o:p)}}s.properties.push({key:d,subkey:a,original:n.original,pos:[0,n.original.length]})}}),i.push(s),i}};var C=require("obsidian");var v=class{constructor(t,e,i,s){this.app=t,this.parent=e,this.content=i,this.references=s}render(){let t=this.parent.createDiv({cls:"search-result-file-matches"});t.addEventListener("click",e=>{let i=this.app.metadataCache.getFirstLinkpathDest(this.references[0].path,"");i&&this.app.workspace.openLinkText(i.name,i.path)}),this.references.forEach(e=>{let i=e.content.sort(n=>n[0]),s=[];for(let n=0;n<e.properties.length;n++){let a=e.properties[n].key.trim()+": "+e.properties[n].original.trim(),r=this.findLineBoundaries(a,e.properties[n].pos,void 0),c=e.properties[n].pos[0]+e.properties[n].key.length+2,o=e.properties[n].pos[1]+e.properties[n].key.length+2;if(s.push([c,o]),n+1<e.properties.length){let l=this.findLineBoundaries(a,e.properties[n+1].pos,void 0);if(r[0]==l[0]&&r[1]==l[1])continue}let p=t.createDiv({cls:"search-result-file-match"});this.highlightMatches(p,a,r[0],r[1],s),s=[]}for(let n=0;n<i.length;n++){let a=this.findLineBoundaries(this.content,i[n],void 0);if(s.push(i[n]),n+1<i.length){let c=this.findLineBoundaries(this.content,i[n+1],void 0);if(a[0]==c[0]&&a[1]==c[1])continue}let r=t.createDiv({cls:"search-result-file-match"});this.highlightMatches(r,this.content,a[0],a[1],s),s=[]}})}findLineBoundaries(t,e,i){i===void 0&&(i=100);let s=e[0]-1,n=0;for(;n<i&&s>=0&&t.charAt(s)!==`
`;)s--,n++;s++;let a=n===i,r=e[1],c=0;for(;c<i&&r<t.length&&t.charAt(r)!==`
`;)r++,c++;return[s,r,a,c===i]}highlightMatches(t,e,i,s,n){(function(a,r,c,o){let p=a;for(let l=0;l<c.length;l++){let d=c[l],f=d[0];if(f>=r)break;let m=d[1];m<a||(f<a&&(f=a),m>r&&(m=r),f>p&&o(!1,p,f),o(!0,f,m),p=m)}p<r&&o(!1,p,r)})(i,s,n,function(a,r,c){let o=e.substring(r,c);a?t.createSpan({cls:"search-result-file-matched-text",text:o}):t.createSpan({text:o})})}};var k=class h{constructor(t,e,i){this.app=t,this.isCollapsed=!1,this.parent=e,this.treeNode=i,this.treeNodeViewChildren=[]}render(){this.treeItem=this.parent.createDiv({cls:"tree-item"}),this.treeItemSelf=this.treeItem.createDiv({cls:"tree-item-self is-clickable backlink-item"}),this.appendEndNode(this.treeItemSelf,this.treeNode);let t=this.treeItemSelf.createDiv({cls:"tree-item-flair-outer"}).createEl("span",{cls:"tree-item-flair"});if(this.treeNode.children.length>0)this.appendTreeItemChildren(this.treeItem,this.treeNode.children);else{let e=this.treeNode.references.reduce((i,s)=>i+=s.content.length+s.properties.length,0);t.setText(e.toString()),this.appendReferences(this.treeItem,this.treeNode,this.treeNode.references)}}appendEndNode(t,e){this.treeItemIcon=t.createDiv({cls:"tree-item-icon collapse-icon"});let i=e.name;if(e.children&&e.children.length==0){let n=this.app.metadataCache.getFirstLinkpathDest(e.name,"");n&&(i=n.basename)}let s=t.createDiv({cls:"tree-item-inner",text:i});(0,C.setIcon)(this.treeItemIcon,"right-triangle"),this.treeItemIcon.addEventListener("click",n=>{this.toggle()}),s.addEventListener("click",n=>{this.navigateTo(e.name)})}appendTreeItemChildren(t,e){let i=t.createDiv({cls:"tree-item-children"});e.forEach(s=>{let n=new h(this.app,i,s);n.render(),this.treeNodeViewChildren.push(n)})}navigateTo(t){let e=this.app.metadataCache.getFirstLinkpathDest(t,"");e&&this.app.workspace.openLinkText(e.name,e.path)}appendReferences(t,e,i){new v(this.app,t,e.content,i).render()}toggleOn(){if(this.treeItemSelf.toggleClass("is-collapsed",!1),this.treeItemIcon.toggleClass("is-collapsed",!1),this.treeItemSelf.nextSibling){let t=this.treeItemSelf.nextSibling;t.style.display="block"}this.treeNodeViewChildren.forEach(t=>{t.toggleOn()})}toggleOff(){if(this.treeItemSelf.toggleClass("is-collapsed",!0),this.treeItemIcon.toggleClass("is-collapsed",!0),this.treeItemSelf.nextSibling){let t=this.treeItemSelf.nextSibling;t.style.display="none"}this.treeNodeViewChildren.forEach(t=>{t.toggleOff()})}toggle(){this.isCollapsed?(this.isCollapsed=!1,this.toggleOff()):(this.isCollapsed=!0,this.toggleOn())}};var D=require("obsidian"),T=require("events"),b=class extends T.EventEmitter{constructor(t,e){super(),this.app=t,this.parent=e}render(){this.button=this.parent.createDiv({cls:"clickable-icon nav-action-button"}),(0,D.setIcon)(this.button,"list"),this.button.addEventListener("click",t=>{this.button.classList.toggle("is-active"),this.emit("collapse-click",t)})}isCollapsed(){return this.button.hasClass("is-active")}};var E=class{constructor(t,e){this.app=t,this.parent=e}render(){let t=this.parent.createDiv({cls:"nav-header"}).createDiv({cls:"nav-buttons-container"});this.collapseButton=new b(this.app,t),this.collapseButton.render()}};var g="hierarchical-backlinks",L=class extends N.ItemView{constructor(e,i){super(e);this.treeNodeViews=[];this.plugin=i}getViewType(){return g}getIcon(){return"links-coming-in"}getDisplayText(){return"Hierarchical backlinks"}async initialize(){let e=this.containerEl.children[1];e.empty();let i=this.app.workspace.getActiveFile();if(i){let n=await new u(this.app,i).getBacklinksHierarchy();this.createPane(e,n)}}createPane(e,i){let s=new E(this.app,e);s.render(),s.collapseButton.on("collapse-click",a=>{s.collapseButton.isCollapsed()?this.treeNodeViews.forEach(r=>{r.toggleOff()}):this.treeNodeViews.forEach(r=>{r.toggleOn()})});let n=e.createDiv({cls:"backlink-pane"});this.appendLinks(n,s,"Linked mentions",i)}appendLinks(e,i,s,n){let a=e.createDiv({cls:"tree-item-self is-clickable"});a.createEl("div",{text:s}),e.appendChild(a);let r=e.createDiv({cls:"search-result-container"});n.length==0?r.createDiv({cls:"search-empty-state",text:"No backlinks found."}):n.forEach(c=>{let o=new k(this.app,r,c);o.render(),this.treeNodeViews.push(o)})}register_events(){this.plugin.registerEvent(this.app.metadataCache.on("changed",()=>{this.initialize()})),this.plugin.registerEvent(this.app.workspace.on("layout-change",()=>{this.initialize()})),this.plugin.registerEvent(this.app.workspace.on("file-open",()=>{this.initialize()}))}async onOpen(){return this.register_events(),this.initialize()}};var I=class extends M.Plugin{async onload(){this.registerView(g,t=>new L(t,this)),this.addCommand({id:"show-hierarchical-backlinks",name:"Show hierarchical backlinks",callback:()=>{this.activateView()}})}async onUserEnable(){this.activateView()}onunload(){}async activateView(){let{workspace:t}=this.app,e=null,i=t.getLeavesOfType(g);i.length>0?e=i[0]:(e=t.getRightLeaf(!1),await(e==null?void 0:e.setViewState({type:g,active:!0}))),t.revealLeaf(e)}};

/* nosourcemap */